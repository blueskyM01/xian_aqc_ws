<!DOCTYPE html>
<html>
<head>
    <title>ROS Image and Results Viewer with Parameter Setter</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: row;
            margin: 0;
            padding: 20px;
        }

        #canvas-container {
            flex: 1;
            margin-right: 20px;
        }

        #results-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        #results-header {
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        #results-columns {
            display: flex;
            flex-wrap: wrap;
        }

        .result-column {
            flex: 1;
            margin-right: 20px;
        }

        #resultsList {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        #resultsList li {
            margin-bottom: 10px;
            border-bottom: 1px solid #ccc;
            padding-bottom: 5px;
        }

        .param-container {
            margin-bottom: 10px;
        }

        .param-container input[type="text"] {
            width: 100px;
            padding: 5px;
            margin-right: 10px;
        }

        .param-container button {
            padding: 5px 10px;
            cursor: pointer;
        }

        /* Media query for smaller screens */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }

            #canvas-container {
                margin-right: 0;
                margin-bottom: 20px;
            }

            .result-column {
                margin-right: 0;
                margin-bottom: 20px;
            }
        }
    </style>
    <script type="text/javascript" src="roslib.min.js"></script>
</head>
<body>
    <div id="canvas-container">
        <h2>Camera Image</h2>
        <canvas id="canvas" width="1024" height="640"></canvas>
    </div>
    <div id="results-container">
        <h2 id="results-header">Xian Results</h2>
        <div id="results-columns">
            <div class="result-column" id="column1">
                <ul id="resultsList1"></ul>
            </div>
            <div class="result-column" id="column2">
                <ul id="resultsList2"></ul>
            </div>
        </div>

        <div class="param-container">
            <label for="param0">mode 0:</label>
            <input type="text" id="param0" placeholder="Enter value">
            <button onclick="setRosParam(0)">Set</button>
        </div>
        <div class="param-container">
            <label for="param1">mode 1:</label>
            <input type="text" id="param1" placeholder="Enter value">
            <button onclick="setRosParam(1)">Set</button>
        </div>
        <div class="param-container">
            <label for="param2">mode 2:</label>
            <input type="text" id="param2" placeholder="Enter value">
            <button onclick="setRosParam(2)">Set</button>
        </div>
        <div class="param-container">
            <label for="param3">mode 3:</label>
            <input type="text" id="param3" placeholder="Enter value">
            <button onclick="setRosParam(3)">Set</button>
        </div>
    </div>

    <script type="text/javascript">
        var ros = new ROSLIB.Ros({
            url : 'ws://localhost:9090'
        });

        ros.on('connection', function() {
            console.log('Connected to websocket server.');
        });

        ros.on('error', function(error) {
            console.log('Error connecting to websocket server: ', error);
        });

        ros.on('close', function() {
            console.log('Connection to websocket server closed.');
        });

        // Image Subscription and Display
        var imageListener = new ROSLIB.Topic({
            ros : ros,
            name : '/xian_visualization',
            messageType : 'sensor_msgs/Image'
        });

        function drawImage(message) {
            var canvas = document.getElementById('canvas');
            canvas.width = message.width;
            canvas.height = message.height;
            var ctx = canvas.getContext('2d');
            var imageData = ctx.createImageData(message.width, message.height);
            var data = imageData.data;

            var binary = atob(message.data);
            var binaryLength = binary.length;
            var bytes = new Uint8Array(binaryLength);
            for (var i = 0; i < binaryLength; i++) {
                bytes[i] = binary.charCodeAt(i);
            }

            for (var i = 0, j = 0; i < bytes.length; i += 3, j += 4) {
                data[j] = bytes[i+2];     // R
                data[j+1] = bytes[i+1];   // G
                data[j+2] = bytes[i];     // B
                data[j+3] = 255;          // A
            }

            ctx.putImageData(imageData, 0, 0);
            console.log('Image drawn on canvas');
        }

        imageListener.subscribe(drawImage);

        // Results Subscription and Display
        var resultsListener = new ROSLIB.Topic({
            ros : ros,
            name : '/xian_results',
            messageType : 'xian_msg_pkg/xian_cell_guide_msg'
        });

        function displayResults(message) {
            var resultsList1 = document.getElementById('resultsList1');
            var resultsList2 = document.getElementById('resultsList2');
            
            resultsList1.innerHTML = ''; // Clear previous results
            resultsList2.innerHTML = ''; // Clear previous results

            var fields = [
                'xian_cell_guide_point_tl_x', 'xian_cell_guide_point_tl_y',
                'xian_cell_guide_point_tr_x', 'xian_cell_guide_point_tr_y',
                'xian_cell_guide_point_bl_x', 'xian_cell_guide_point_bl_y',
                'xian_cell_guide_point_br_x', 'xian_cell_guide_point_br_y',
                'xian_container_corner_point_tl_x', 'xian_container_corner_point_tl_y',
                'xian_container_corner_point_tr_x', 'xian_container_corner_point_tr_y',
                'xian_container_corner_point_bl_x', 'xian_container_corner_point_bl_y',
                'xian_container_corner_point_br_x', 'xian_container_corner_point_br_y',
                'xian_gantry_pixel_error', 'xian_trolley_pixel_error', 'xian_rotate_pixel_error',
                'error_code',
                'retract_box_state0', 'retract_box_state1', 'retract_box_state2', 'retract_box_state3',
                'retract_box_mode0', 'retract_box_mode1', 'retract_box_mode2', 'retract_box_mode3'
            ];

            // Split fields into two columns
            var halfLength = Math.ceil(fields.length / 2);
            var fieldsColumn1 = fields.slice(0, halfLength);
            var fieldsColumn2 = fields.slice(halfLength);

            fieldsColumn1.forEach(function(field) {
                var listItem = document.createElement('li');
                listItem.textContent = field + ': ' + message[field];
                resultsList1.appendChild(listItem);
            });

            fieldsColumn2.forEach(function(field) {
                var listItem = document.createElement('li');
                listItem.textContent = field + ': ' + message[field];
                resultsList2.appendChild(listItem);
            });
        }

        resultsListener.subscribe(displayResults);

        // ROS Parameter Setting
        function setRosParam(index) {
            var paramName = '/xian_aqc_dynamic_parameters_server/xian_acds_send_to_retrable_box_mode' + index;
            var paramValue = document.getElementById('param' + index).value;
            
            var param = new ROSLIB.Param({
                ros : ros,
                name : paramName
            });

            param.set(parseInt(paramValue), function() {
                console.log('ROS parameter ' + paramName + ' set to ' + paramValue);
                alert('ROS parameter ' + paramName + ' set to ' + paramValue);
            });
        }
    </script>
</body>
</html>
